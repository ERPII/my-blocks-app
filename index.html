<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBlocks - ניהול תוכן</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; }
        
        /* עיצוב להודעה הקופצת */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-[#f8fafc] p-4 md:p-8">

    <div id="toast"><i class="fas fa-check-circle text-green-400 mr-2"></i> הקישור הועתק בהצלחה!</div>

    <div class="max-w-6xl mx-auto">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-white mb-10">
            <h1 id="form-title" class="text-2xl font-extrabold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fas fa-plus-circle text-indigo-500"></i> צור קוביית תוכן
            </h1>
            <input type="hidden" id="edit-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-600 mr-2">כותרת הקובייה</label>
                    <input type="text" id="title" placeholder="מה הכותרת?" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-indigo-400 transition">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-600 mr-2">קישור ליעד (אופציונלי)</label>
                    <input type="url" id="url" placeholder="https://..." class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-indigo-400 transition" dir="ltr">
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-sm font-bold text-slate-600 mr-2">תיאור התוכן</label>
                    <textarea id="description" placeholder="כתוב כאן את מה שתרצה שיופיע..." class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-indigo-400 h-28 resize-none"></textarea>
                </div>
                <div class="md:col-span-2">
                    <div class="relative w-full h-20 border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center hover:bg-slate-50 transition cursor-pointer">
                        <input type="file" id="media-file" class="absolute inset-0 opacity-0 cursor-pointer">
                        <div class="text-slate-400 text-sm font-bold"><i class="fas fa-image mr-2"></i> לחץ להעלאת תמונה או וידאו</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex gap-3">
                <button onclick="saveBlock()" id="save-btn" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-black hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 active:scale-95">שמור קובייה ✨</button>
                <button onclick="resetForm()" id="cancel-btn" class="hidden bg-slate-200 text-slate-600 px-10 py-4 rounded-2xl font-bold hover:bg-slate-300 transition">ביטול</button>
            </div>
        </div>

        <h2 class="text-xl font-black text-slate-700 mb-6 flex items-center gap-2">
            <i class="fas fa-th-large text-indigo-400"></i> הקוביות שלי
        </h2>
        
        <div id="blocks-canvas" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, orderBy, query, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0f0u0WqlScU5r9PE0wm0GkKA3f1MFHv8",
            authDomain: "myblocksapp-a7d1c.firebaseapp.com",
            projectId: "myblocksapp-a7d1c",
            storageBucket: "myblocksapp-a7d1c.firebasestorage.app",
            messagingSenderId: "273089143135",
            appId: "1:273089143135:web:7544f1810bc21b4a5856ea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const blocksCol = collection(db, "blocks");

        onSnapshot(query(blocksCol, orderBy("createdAt", "desc")), (snapshot) => {
            const canvas = document.getElementById('blocks-canvas');
            canvas.innerHTML = '';
            
            snapshot.forEach((fbDoc) => {
                const d = fbDoc.data();
                const shareUrl = `${window.location.origin}/view.html?id=${fbDoc.id}`;
                
                const card = `
                    <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-slate-100 hover:shadow-xl transition-all group">
                        <div class="h-48 bg-slate-100 relative overflow-hidden">
                            ${d.mediaUrl ? `<img src="${d.mediaUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">` : `<div class="w-full h-full flex items-center justify-center text-slate-300"><i class="fas fa-box-open text-4xl"></i></div>`}
                            <div class="absolute top-4 left-4 flex gap-2">
                                <button onclick="editBlock('${fbDoc.id}')" class="w-8 h-8 bg-white/90 backdrop-blur rounded-full text-blue-500 shadow-sm flex items-center justify-center hover:bg-blue-500 hover:text-white transition"><i class="fas fa-edit text-xs"></i></button>
                                <button onclick="deleteBlock('${fbDoc.id}', '${d.mediaUrl || ''}')" class="w-8 h-8 bg-white/90 backdrop-blur rounded-full text-red-400 shadow-sm flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-lg text-slate-800 mb-2 truncate">${d.title}</h3>
                            <p class="text-slate-500 text-sm mb-6 line-clamp-2 h-10">${d.description || 'אין תיאור זמין'}</p>
                            
                            <div class="flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <button onclick="copyLink('${shareUrl}')" class="flex-1 py-3 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                                        <i class="fas fa-link"></i> העתק קישור
                                    </button>
                                    <button onclick="shareWhatsApp('${d.title}', '${d.description || ""}', '${shareUrl}')" class="w-12 py-3 bg-green-50 text-green-600 rounded-xl hover:bg-green-100 transition flex items-center justify-center">
                                        <i class="fab fa-whatsapp text-lg"></i>
                                    </button>
                                </div>
                                <a href="${shareUrl}" target="_blank" class="w-full py-3 bg-slate-800 text-white rounded-xl text-xs font-bold text-center hover:bg-slate-900 transition flex items-center justify-center gap-2">
                                     <i class="fas fa-external-link-alt"></i> צפייה בתוכן
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                canvas.innerHTML += card;
            });
        });

        window.saveBlock = async () => {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const url = document.getElementById('url').value;
            const file = document.getElementById('media-file').files[0];

            if(!title) return alert("חובה למלא כותרת!");

            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "מעבד...";

            try {
                let mediaUrl = "";
                let mediaType = "";
                if(file) {
                    const sRef = ref(storage, `content/${Date.now()}_${file.name}`);
                    await uploadBytes(sRef, file);
                    mediaUrl = await getDownloadURL(sRef);
                    mediaType = file.type;
                }

                const payload = { title, description: description || "", url: url || "", createdAt: new Date() };
                if(mediaUrl) { payload.mediaUrl = mediaUrl; payload.mediaType = mediaType; }

                if(id) await updateDoc(doc(db, "blocks", id), payload);
                else await addDoc(blocksCol, payload);
                resetForm();
            } catch(e) { alert("שגיאה: " + e.message); }
            finally { btn.disabled = false; btn.innerText = "שמור קובייה ✨"; }
        };

        window.copyLink = (txt) => {
            navigator.clipboard.writeText(txt);
            const t = document.getElementById("toast");
            t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        };

        window.shareWhatsApp = (title, desc, url) => {
            const text = `*${title}*\n${desc}\n\nלצפייה:\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.deleteBlock = async (id, mUrl) => {
            if(!confirm("למחוק את הקובייה?")) return;
            if(mUrl) await deleteObject(ref(storage, mUrl)).catch(() => {});
            await deleteDoc(doc(db, "blocks", id));
        };

        window.editBlock = async (id) => {
            const snap = await getDoc(doc(db, "blocks", id));
            const d = snap.data();
            document.getElementById('edit-id').value = id;
            document.getElementById('title').value = d.title;
            document.getElementById('description').value = d.description || "";
            document.getElementById('url').value = d.url || "";
            document.getElementById('form-title').innerHTML = '<i class="fas fa-edit text-blue-500"></i> עריכת קובייה';
            document.getElementById('cancel-btn').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.resetForm = () => {
            document.getElementById('edit-id').value = "";
            document.getElementById('title').value = "";
            document.getElementById('description').value = "";
            document.getElementById('url').value = "";
            document.getElementById('media-file').value = "";
            document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle text-indigo-500"></i> צור קוביית תוכן';
            document.getElementById('cancel-btn').classList.add('hidden');
        };
    </script>
</body>
</html>