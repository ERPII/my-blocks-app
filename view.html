<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Mode - Smart Slider</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #000; color: black; margin: 0; overflow: hidden; }
        
        /* אנימציה מוגדרת מראש, אך נפעיל אותה רק במידת הצורך */
        @keyframes scrollUp {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }

        .should-scroll {
            animation: scrollUp var(--speed, 15s) linear infinite;
        }

        .scroll-container {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scroll-content {
            position: relative;
            width: 100%;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .full-screen-msg {
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw; text-align: center; padding: 2rem;
            font-size: 3.5rem; font-weight: 800; background: #000;
        }
    </style>
</head>
<body>

    <div id="displayContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0f0u0WqlScU5r9PE0wm0GkKA3f1MFHv8",
            authDomain: "myblocksapp-a7d1c.firebaseapp.com",
            projectId: "myblocksapp-a7d1c",
            storageBucket: "myblocksapp-a7d1c.firebasestorage.app",
            messagingSenderId: "273089143135",
            appId: "1:273089143135:web:7544f1810bc21b4a5856ea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const blockId = params.get('id');
        let blockData = null;

        if (!blockId) {
            document.getElementById('displayContainer').innerHTML = `<div class="full-screen-msg">שגיאה: ID חסר</div>`;
        } else {
            onSnapshot(doc(db, "blocks", blockId), (snap) => {
                if (snap.exists()) {
                    blockData = snap.data();
                    renderContent();
                } else {
                    document.getElementById('displayContainer').innerHTML = `<div class="full-screen-msg text-slate-700">התוכן אינו זמין יותר</div>`;
                }
            });
        }

        function renderContent() {
            if (!blockData) return;

            const now = new Date();
            const start = blockData.scheduleDate ? new Date(blockData.scheduleDate) : null;
            const end = blockData.expiryDate ? new Date(blockData.expiryDate) : null;
            const container = document.getElementById('displayContainer');

            // בדיקת זמנים
            if (start && now < start) {
                container.innerHTML = `<div class="full-screen-msg text-blue-400">${blockData.preMsg || 'ממתינים לתחילת השידור...'}</div>`;
                return;
            }
            if (end && now > end) {
                container.innerHTML = `<div class="full-screen-msg text-red-500">${blockData.postMsg || 'השידור הסתיים'}</div>`;
                return;
            }

            // יצירת מבנה התוכן
            const media = blockData.mediaUrls?.[0] ? `<img src="${blockData.mediaUrls[0]}" class="w-full max-h-[40vh] object-contain rounded-3xl mb-6 shadow-2xl">` : '';
            
            container.innerHTML = `
                <div class="h-screen w-screen flex flex-col p-8 overflow-hidden" style="background-color: ${blockData.bgColor || '#000'}">
                    <div id="headerSection" class="w-full max-w-5xl mx-auto flex flex-col items-center flex-shrink-0">
                        ${media}
                        <h1 class="text-5xl font-black mb-6 text-center leading-tight">${blockData.title}</h1>
                    </div>
                    
                    <div id="scrollWrapper" class="scroll-container flex-grow w-full max-w-5xl mx-auto">
                        <div id="textContent" class="scroll-content text-3xl font-bold leading-relaxed">
                            ${blockData.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;

            // הפעלת לוגיקת הדינמיות (האם להגליל?)
            setTimeout(checkIfScrollNeeded, 100); 
        }

        function checkIfScrollNeeded() {
            const wrapper = document.getElementById('scrollWrapper');
            const content = document.getElementById('textContent');
            
            if (!wrapper || !content) return;

            // אם גובה הטקסט גדול מגובה המיכל שנשאר לו במסך
            if (content.scrollHeight > wrapper.offsetHeight) {
                content.classList.add('should-scroll');
                content.style.setProperty('--speed', (blockData.slideSpeed || 15) + 's');
            } else {
                // אם הטקסט קטן, נמרכז אותו יפה באמצע
                content.classList.remove('should-scroll');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
            }
        }

        // בדיקה אוטומטית כל 30 שניות (מעדכן הודעות זמן בלי רענון)
        setInterval(renderContent, 30000);

        // עדכון במקרה של שינוי גודל חלון
        window.addEventListener('resize', checkIfScrollNeeded);

    </script>
</body>
</html>
