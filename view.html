<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Mode - Auto Refresh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #000; color: white; margin: 0; overflow: hidden; }
        
        /* אנימציית גלילה */
        @keyframes scrollUp {
            0% { transform: translateY(100vh); }
            100% { transform: translateY(-100%); }
        }
        .scroll-content {
            animation: scrollUp var(--speed, 15s) linear infinite;
        }
        .full-screen-msg {
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw; text-align: center; padding: 2rem;
            font-size: 3rem; font-weight: 800; background: #111;
        }
    </style>
</head>
<body>

    <div id="displayContainer">
        <div class="full-screen-msg text-slate-500">טוען נתונים...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0f0u0WqlScU5r9PE0wm0GkKA3f1MFHv8",
            authDomain: "myblocksapp-a7d1c.firebaseapp.com",
            projectId: "myblocksapp-a7d1c",
            storageBucket: "myblocksapp-a7d1c.firebasestorage.app",
            messagingSenderId: "273089143135",
            appId: "1:273089143135:web:7544f1810bc21b4a5856ea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // שליפת ה-ID מהכתובת
        const params = new URLSearchParams(window.location.search);
        const blockId = params.get('id');
        let blockData = null;

        if (!blockId) {
            document.getElementById('displayContainer').innerHTML = `<div class="full-screen-msg">שגיאה: קוד לא נמצא</div>`;
        } else {
            // האזנה לשינויים ב-DB (זמן אמת)
            onSnapshot(doc(db, "blocks", blockId), (snap) => {
                if (snap.exists()) {
                    blockData = snap.data();
                    renderContent(); // רינדור ראשוני
                } else {
                    document.getElementById('displayContainer').innerHTML = `<div class="full-screen-msg">התוכן נמחק על ידי המנהל</div>`;
                }
            });
        }

        function renderContent() {
            if (!blockData) return;

            const now = new Date();
            const start = blockData.scheduleDate ? new Date(blockData.scheduleDate) : null;
            const end = blockData.expiryDate ? new Date(blockData.expiryDate) : null;
            const container = document.getElementById('displayContainer');

            // בדיקה 1: האם עוד לא הגיע הזמן?
            if (start && now < start) {
                container.innerHTML = `<div class="full-screen-msg text-blue-400">${blockData.preMsg || 'השידור טרם החל'}</div>`;
                return;
            }

            // בדיקה 2: האם עבר הזמן?
            if (end && now > end) {
                container.innerHTML = `<div class="full-screen-msg text-red-500">${blockData.postMsg || 'השידור הסתיים'}</div>`;
                return;
            }

            // בדיקה 3: התוכן פעיל - מציגים את הסליידר
            const media = blockData.mediaUrls?.[0] ? `<img src="${blockData.mediaUrls[0]}" class="w-full h-64 object-cover rounded-3xl mb-8 shadow-2xl">` : '';
            
            container.innerHTML = `
                <div class="relative h-screen w-screen flex flex-col items-center justify-center p-10 overflow-hidden" style="background-color: ${blockData.bgColor || '#000'}">
                    <div class="z-10 w-full max-w-4xl">
                        ${media}
                        <h1 class="text-6xl font-black mb-10 text-center">${blockData.title}</h1>
                    </div>
                    <div class="scroll-container flex-1 w-full max-w-4xl relative">
                        <div class="scroll-content text-4xl font-bold text-center leading-loose" style="--speed: ${blockData.slideSpeed || 15}s">
                            ${blockData.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- המנגנון שחיפשת: בדיקה אוטומטית כל 30 שניות ---
        setInterval(() => {
            console.log("מבצע בדיקת זמן אוטומטית...");
            renderContent(); 
        }, 30000); // 30,000 מילישניות = חצי דקה

    </script>
</body>
</html>
